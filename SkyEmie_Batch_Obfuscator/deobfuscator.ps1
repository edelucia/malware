# www.emanueledelucia.net                                          #
# SkyEmie Batch Deobuscator                                        #
# This code is provided as is and without any warranty.            #
# Be careful to only work with malware in controlled environments. #
# Author: Emanuele De Lucia                                        #
####################################################################

function Deobfuscate {
    param (
        [string]$inputFile,
        [string]$outputFile
    )

    # Leggi il contenuto del file offuscato
    $content = Get-Content -Path $inputFile -Raw

    # Estrai la definizione della variabile di offuscamento
    if ($content -match '@set "([^"]+)=([^"]+)"') {
        $varName = $matches[1]
        $varValue = $matches[2]

        # Crea una mappa di sostituzione basata sulla variabile
        $map = @{}
        for ($i = 0; $i -lt $varValue.Length; $i++) {
            $key = "%${varName}:~$i,1%"
            $map[$key] = $varValue[$i]
        }

        # Sostituisci le variabili offuscate nel contenuto
        foreach ($key in $map.Keys) {
            $content = $content -replace [regex]::Escape($key), $map[$key]
        }

        # Rimuovi le variabili di offuscamento e qualsiasi carattere aggiuntivo
        $content = $content -replace '@set "[^"]+"', ''
        $content = $content -replace '&@cls&', ''
        $content = $content -replace "\xFF\xFE", ''
        $content = $content -replace '[^ -~\r\n]', ''  # Rimuovi caratteri non stampabili
        $content = $content -replace '%[a-zA-Z0-9]{2,}%', ''

        # Scrivi il contenuto deoffuscato nel file di output
        Set-Content -Path $outputFile -Value $content

        Write-Output "Deoffuscation completed. Output file: $outputFile"
    } else {
        Write-Output "Pattern not found in the file. Ensure the file is properly obfuscated."
    }
}

Deobfuscate -inputFile "[mypath]/[mybat]" -outputFile "[mypath]/[mytxt]"
